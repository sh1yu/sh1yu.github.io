<!DOCTYPE html>
<html
  dir="ltr"
  lang="zh-cn"
  data-theme="light"
><head>
  <title>
    psycode
      |
      一次springboot&#43;dubbo的项目实战


    

  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.88.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta
    name="description"
    content="
      better code, better life.


    "
  />
  
  
  
  <link
    rel="stylesheet"
    href="/css/main.min.62c68e6209f6e0ad6a21a6c89488202f1ac09c13fc07856ebd509ecd54ab3196.css"
    integrity="sha256-YsaOYgn24K1qIabIlIggLxrAnBP8B4VuvVCezVSrMZY="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.8e4c8f0a940b1596fb4c64d28a00a5ceed671fc303cb65178b4947417da9c674.css"
    integrity="sha256-jkyPCpQLFZb7TGTSigClzu1nH8MDy2UXi0lHQX2pxnQ="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
    crossorigin="anonymous"
  />
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

  <link rel="canonical" href="/post/%E4%B8%80%E6%AC%A1springboot&#43;dubbo%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.2a2cd9614b7d007dfbb75e8da19e3a0fa872ceab53c6d000c00b7a0c89b85bfc.js"
    integrity="sha256-KizZYUt9AH37t16NoZ46D6hyzqtTxtAAwAt6DIm4W/w="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js"
      integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus="
      crossorigin="anonymous"
    ></script>

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="一次springboot&#43;dubbo的项目实战"/>
<meta name="twitter:description" content="最近在从零开始实现一个服务端在线接口项目，项目选型为springboot &#43; dubbo。由于是新项目，没有历史包袱，所以给了自己一次从头开始按照想法进行最优编码实践的机会。
1. 功能实现 项目使用springboot-web暴露网关接口，内部通过dubbo调用服务，比如用户服务。主要组件基本包括两块：gateway和service-provider。其中gateway对外暴露web端口，对内为dubbo的consumer。 通用的启动程序：
@SpringBootApplication @EnableAspectJAutoProxy @EnableDubbo @Slf4j public class MainApplication { public static void main(String[] args) { SpringApplication."/>



  


  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "post",
        "name": "一次springboot\u002bdubbo的项目实战",
        "headline": "一次springboot\u002bdubbo的项目实战",
        "alternativeHeadline": "",
        "description": "
      
        最近在从零开始实现一个服务端在线接口项目，项目选型为springboot \u002b dubbo。由于是新项目，没有历史包袱，所以给了自己一次从头开始按照想法进行最优编码实践的机会。\n1. 功能实现 项目使用springboot-web暴露网关接口，内部通过dubbo调用服务，比如用户服务。主要组件基本包括两块：gateway和service-provider。其中gateway对外暴露web端口，对内为dubbo的consumer。 通用的启动程序：\n@SpringBootApplication @EnableAspectJAutoProxy @EnableDubbo @Slf4j public class MainApplication { public static void main(String[] args) { SpringApplication.


      


    ",
        "inLanguage": "zh-cn",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/sh1yu.github.io\/post\/%E4%B8%80%E6%AC%A1springboot\u002bdubbo%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98\/"
        },
        "author" : {
            "@type": "Person",
            "name": "psycode"
        },
        "creator" : {
            "@type": "Person",
            "name": "psycode"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "psycode"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "psycode"
        },
        "copyrightYear" : "2021",
        "dateCreated": "2021-04-05T00:11:49.00Z",
        "datePublished": "2021-04-05T00:11:49.00Z",
        "dateModified": "2021-04-05T00:11:49.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "psycode",
            "url": "https://sh1yu.github.io",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/sh1yu.github.iofavicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/sh1yu.github.io\/post\/%E4%B8%80%E6%AC%A1springboot\u002bdubbo%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98\/",
        "wordCount" : "1048",
        "genre" : [ 
      
      "coding"

    ],
        "keywords" : [ 
      
      "java"

    
      
        ,

      
      "springboot"

    
      
        ,

      
      "dubbo"

    ]
    }
  </script>



</head>
<body>
    <header><div
  class="page-top 
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
  </a>
  <nav>
    <ul class="nav__list" id="navMenu">
      <div class="nav__links">
        
        
          
          <li>
            <a
              
              href="/"
              
              title=""
              >主页</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/post/"
              
              title=""
              >文章</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/about/"
              
              title=""
              >关于我</a
            >
          </li>

        
        
      </div>
      <li>
        
          <a class="theme-switch" title="Switch Theme">
            <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
          </a>

        
      </li>
    </ul>
  </nav>
</div>
</header>
    <div class="wrapper">
      <aside><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="logo-title">
      <div class="title">
        <img src="https://avatars.githubusercontent.com/u/4922741?s=400&amp;u=c325c94d790c852dca971de31d50d93dc50a1e74&amp;v=4" alt="profile picture" />
        <h3 title=""><a href="/">psy&#39;s code</a></h3>
        <div class="description">
          <p>better code, better life.</p>
        </div>
      </div>
    </div>
    <ul class="social-links">
      
    </ul>
  </div><footer class="footer footer--sidebar">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2019-2021

        
      </li>
      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js"
    integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main>
        <div class="autopagerize_page_element">
          <div class="content">
  <div
    class="post 
      animated fadeInDown

    "
  >
    <div class="post-content">
      
      <div class="post-title">
        <h1>一次springboot&#43;dubbo的项目实战</h1>
        
          <div class="info">
            <em class="fas fa-calendar-day"></em>
            <span class="date"
              >
                Mon, Apr 5, 2021


              </span
            >
            <em class="fas fa-stopwatch"></em>
            <span class="reading-time">阅读时间 5 分钟</span>
          </div>

        
      </div><p>最近在从零开始实现一个服务端在线接口项目，项目选型为springboot + dubbo。由于是新项目，没有历史包袱，所以给了自己一次从头开始按照想法进行最优编码实践的机会。</p>
<h1 id="1-功能实现">1. 功能实现</h1>
<p>项目使用springboot-web暴露网关接口，内部通过dubbo调用服务，比如用户服务。主要组件基本包括两块：gateway和service-provider。其中gateway对外暴露web端口，对内为dubbo的consumer。
通用的启动程序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableAspectJAutoProxy</span>
<span class="nd">@EnableDubbo</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">MainApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">CommandLineRunner</span> <span class="nf">commandLineRunner</span><span class="o">(</span><span class="n">ApplicationContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;==============================================&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="11-配置文件加载">1.1 配置文件加载</h2>
<p>spring boot对配置有着相当完善的支持。除了默认使用的spring.application.name、server.port等配置以及dubbo附加支持的dubbo.protocol.name、dubbo.registry.address等配置外，还可以直接添加自己的配置并在项目中直接使用。</p>
<p>配置可以直接写在默认配置文件application.properties或者application.yaml中，也可以写入自己的properties配置文件中然后通过spring加载解析，或者干脆放到一个文件目录中由自己加载。</p>
<p>关于application.properties和application.yaml需要注意的一个区别是，在spring boot 中application.properties是以iso8859-1编码读取的，application.yaml是以utf-8编码读取的。这意味着如果application.properties中存在中文配置的话，一定要记得编码转换：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">String</span> <span class="n">loadingValue</span> <span class="o">=</span> <span class="s">&#34;some string loaded from properties with spring boot&#34;</span><span class="o">;</span>
<span class="n">String</span> <span class="n">correctValue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">loadingValue</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">ISO_8859_1</span><span class="o">),</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</code></pre></div><p>如果是直接写入application.properties的自定义配置，可以直接使用@Value注解在代码中进行使用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceImpl</span> <span class="kd">implements</span> <span class="n">IService</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${user.extra.config:default_val}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">exteaConfig</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>如果是使用了新的配置文件，则需要使用@PropertySource注解指定该配置文件。另外，我们也可以直接使用@ConfigurationProperties注解将配置属性绑定到bean上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Data</span>
<span class="nd">@Component</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;user.extra&#34;</span><span class="o">)</span>
<span class="nd">@PropertySource</span><span class="o">(</span><span class="s">&#34;classpath:config/extra.properties&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserExtraConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">extraValue</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>关于@Value和@ConfigurationProperties区别，网上有人做了测试和总结如下：</p>
<p><img src="/pic/%E4%B8%80%E6%AC%A1springboot+dubbo%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/1.jpg" alt=""></p>
<p>如果是自己加载配置文件，可以使用springboot自带的ResourceUtils工具，支持从classpath下读取配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">ResourceUtils</span><span class="o">.</span><span class="na">getFile</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>
<span class="n">String</span> <span class="n">configuration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copyToByteArray</span><span class="o">(</span><span class="n">keyFile</span><span class="o">));</span>
</code></pre></div><p>需要注意的是，如果filepath是以classpath:开头，这时使用File的方式是读取不到打包在jar包中的资源文件的，需要以Stream的方式读取：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">ResourceUtils</span><span class="o">.</span><span class="na">getURL</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>
<span class="n">String</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copyToString</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">openStream</span><span class="o">()));</span> 
</code></pre></div><h2 id="12-鉴权">1.2 鉴权</h2>
<p>业务的每个接口都需要做鉴权逻辑。项目中通用的鉴权逻辑是hmac-auth。由于鉴权逻辑通用，考虑利用切面或者拦截器的方式统一处理。具体实现方式大概有如下几种：</p>
<ul>
<li>java servlet中的filter。spring boot web底层也是基于servlet技术，所以这个拦截比较底层，而且直接拦截的是原始的HttpServletRequest和HttpServletResponse对象。</li>
<li>spring mvc中的Interceptor。和filter类似，也能基于原始请求对象进行处理和拦截。</li>
<li>@RestControllerAdvice。这个是spring提供的用于全局拦截@RequestMapping的注解。主要提供了@ExceptionHandler、@InitBinder、@ModelAttribute三个处理入口。本项目中使用此种方式对全局的异常进行了统一处理和拦截，后面如果有非预期的错误出现，直接抛出相关异常即可：</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="nd">@RestControllerAdvice</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;org.xxx...&#34;</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlobalExceptionHandler</span> <span class="o">{</span>

    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">UnAuthorizedException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">BizResponse</span> <span class="nf">unAuthorizedExceptionHandle</span><span class="o">(</span><span class="n">UnAuthorizedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">BizResponse</span><span class="o">(</span><span class="n">RetCode</span><span class="o">.</span><span class="na">AUTHFAILEDERR</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">BizResponse</span> <span class="nf">exceptionHandle</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;unknown error&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">BizResponse</span><span class="o">(</span><span class="n">RetCode</span><span class="o">.</span><span class="na">UNKNOWNERR</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>aspectJ切面拦截。这种方式可以指定对某些方法（比如Controller方法）进行拦截。</li>
</ul>
<p>本项目中采用aspectJ进行统一的hmac-auth鉴权逻辑的开发。使用aspectJ的一大问题在于无法获取到原始请求的header等信息，而这些信息鉴权中是必须的。好在可以通过spring web提供的RequestContextHolder来解决这个问题。RequestContextHolder本质上是 一个ThreadLocal对象，它存储了此次处理的原始请求request和session信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthAspect</span> <span class="o">{</span>

    <span class="nd">@Pointcut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;execution(* org.controller..*(..))&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">pointcut</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;pointcut()&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doBefore</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">RequestAttributes</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">getRequestAttributes</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">attributes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnAuthException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">ContentCachingRequestWrapper</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">ContentCachingRequestWrapper</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">resolveReference</span><span class="o">(</span><span class="n">RequestAttributes</span><span class="o">.</span><span class="na">REFERENCE_REQUEST</span><span class="o">);</span>
        <span class="c1">//do session check...
</span><span class="c1"></span>        <span class="n">signature</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>其中，request是ContentCachingRequestWrapper类型，该类型提供了一种能够反复读取body内容的方法。原始的request是HttpServletRequest类型，该类型body只能读取一次，满足不了鉴权需要读取一次以及业务处理需要读取一次的需求。因此需要依赖于filter对原始请求做一次拦截转换：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RequestFilter</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="k">new</span> <span class="n">ContentCachingRequestWrapper</span><span class="o">(</span><span class="n">request</span><span class="o">),</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="13-第三方调用">1.3 第三方调用</h2>
<p>对于dubbo service来说，通过网络调用第三方的接口（比如统一账号系统）再正常不过。项目中在调用第三方系统时在中间加了一层接口，调用层和实现层通过接口分割开。这样一来，满足了依赖倒置原则，添加不同的第三方系统实现就很方便了。当然，更多的策略比如说第三方系统调用负载均衡、降级熔断等都可以在这一层实现。目前项目没有这些需求，暂时只是做了一层接口隔离。</p>
<h2 id="14-测试">1.4 测试</h2>
<p>此前一直还在纠结”测试“这个方面到底算是功能还是非功能。最后我认为还是作为功能的一部分比较好。虽然测试代码不直接运行于生产环境中，但是它对于生产环境的代码的质量影响还是非常重要的，写测试也应该作为正常编码工作的一部分重要内容，不容忽视。</p>
<p>项目中我采用了spring-boot-test + Mockito的测试工具。Mockito对于bean的mock功能支持的也比较好：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SignatureServiceTest</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">Signature</span> <span class="n">signature</span><span class="o">;</span>

    <span class="nd">@MockBean</span><span class="o">(</span><span class="n">answer</span> <span class="o">=</span> <span class="n">Answers</span><span class="o">.</span><span class="na">RETURNS_DEEP_STUBS</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>    

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCheck1</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">NoSuchMethodException</span><span class="o">,</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">IllegalAccessException</span> <span class="o">{</span>

        <span class="n">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">()</span>
                       <span class="o">.</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="n">Mockito</span><span class="o">.</span><span class="na">anyString</span><span class="o">(),</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">anyString</span><span class="o">(),</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">any</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">class</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">null</span><span class="o">).</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="n">Method</span> <span class="n">m</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;check&#34;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">m</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Result</span> <span class="n">r1</span> <span class="o">=</span> <span class="o">(</span><span class="n">Result</span><span class="o">)</span> <span class="n">m</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">signature</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">);</span>
        <span class="n">Result</span> <span class="n">r2</span> <span class="o">=</span> <span class="o">(</span><span class="n">Result</span><span class="o">)</span> <span class="n">m</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">signature</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">);</span>
        <span class="n">Result</span> <span class="n">r3</span> <span class="o">=</span> <span class="o">(</span><span class="n">Result</span><span class="o">)</span> <span class="n">m</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">signature</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">);</span>

        <span class="n">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">(),</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">times</span><span class="o">(</span><span class="n">3</span><span class="o">))</span>
               <span class="o">.</span><span class="na">setIfAbsent</span><span class="o">(</span><span class="n">Mockito</span><span class="o">.</span><span class="na">anyString</span><span class="o">(),</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">anyString</span><span class="o">(),</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">any</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">Assertions</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">r1</span><span class="o">.</span><span class="na">isPass</span><span class="o">());</span>
        <span class="n">Assertions</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">r2</span><span class="o">.</span><span class="na">isPass</span><span class="o">());</span>
        <span class="n">Assertions</span><span class="o">.</span><span class="na">assertFalse</span><span class="o">(</span><span class="n">r3</span><span class="o">.</span><span class="na">isPass</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>在测试代码中，使用反射方式调用那些私有的方法；使用@MockBean注解处理那些需要mock的bean；另外可以使用Answers.RETURNS_DEEP_STUBS来处理那些需要mock链式调用的情形。</p>
<p>由于是dubbo项目，在运行测试的过程中很尴尬的一点是启动spring环境时dubbo也随之启动了，哪怕真正的调用并没有去调用dubbo服务。没有找到相关关闭dubbo服务提供者和消费者的方法，只能在测试环境中禁止使用远程的配置中心和禁止远程调用。需要在test下的resources目录下的application.properties中进行如下配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">dubbo.protocol.name=dubbo
dubbo.protocol.port=12345
dubbo.registry.address=N/A
dubbo.consumer.scope=local
</code></pre></div><h1 id="2-非功能需求">2. 非功能需求</h1>
<h2 id="21-文档">2.1 文档</h2>
<p>对于一个接口项目来说，将文档和代码一起发布无疑是最好的选择。这样就不用担心文档过时缺失等问题了，也不用花很大力气去维护文档。项目中引入了<code>swagger2</code>来达到这个目的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@EnableSwagger2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Swagger2Config</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Docket</span> <span class="nf">createRestApi</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Docket</span><span class="o">(</span><span class="n">DocumentationType</span><span class="o">.</span><span class="na">SWAGGER_2</span><span class="o">)</span>
                <span class="o">.</span><span class="na">apiInfo</span><span class="o">(</span><span class="n">apiInfo</span><span class="o">())</span>
                <span class="o">.</span><span class="na">select</span><span class="o">()</span>
                <span class="o">.</span><span class="na">apis</span><span class="o">(</span><span class="n">RequestHandlerSelectors</span><span class="o">.</span><span class="na">basePackage</span><span class="o">(</span><span class="s">&#34;org.xxx.controller&#34;</span><span class="o">))</span>
                <span class="o">.</span><span class="na">paths</span><span class="o">(</span><span class="n">PathSelectors</span><span class="o">.</span><span class="na">any</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// API的详细信息
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">ApiInfo</span> <span class="nf">apiInfo</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiInfoBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">title</span><span class="o">(</span><span class="s">&#34;my_title&#34;</span><span class="o">)</span> <span class="c1">//标题
</span><span class="c1"></span>                <span class="o">.</span><span class="na">description</span><span class="o">(</span><span class="s">&#34;interface api docs&#34;</span><span class="o">)</span> <span class="c1">//描述
</span><span class="c1"></span>                <span class="o">.</span><span class="na">contact</span><span class="o">(</span><span class="k">new</span> <span class="n">Contact</span><span class="o">(</span><span class="s">&#34;codeme&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">))</span>
                <span class="o">.</span><span class="na">version</span><span class="o">(</span><span class="s">&#34;v1&#34;</span><span class="o">)</span> <span class="c1">//版本号
</span><span class="c1"></span>                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>配置好如上bean后，直接在Controller接口层配置注解即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Api</span><span class="o">(</span><span class="n">tags</span> <span class="o">=</span> <span class="s">&#34;测试接口&#34;</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;test&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>
    <span class="nd">@ApiOperation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="o">,</span> <span class="n">notes</span> <span class="o">=</span> <span class="s">&#34;test hello API&#34;</span><span class="o">)</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/v1/hello&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">GWResponse</span><span class="o">&lt;?&gt;</span> <span class="n">hello</span><span class="o">(</span>
            <span class="nd">@ApiParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;请求包&#34;</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
            <span class="nd">@RequestBody</span> <span class="n">BizRequest</span> <span class="n">bizRequest</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="22-日志">2.2 日志</h2>
<p>如何记录日志我觉得是对于在线接口来说是非常重要的事，它是事后线上问题排查、数据统计等最为重要的途径。本项目使用slf4j的MDC进行统一的日志拦截和打印：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogAspect</span> <span class="o">{</span>
    <span class="nd">@Pointcut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;execution(* org.xxx.controller..*(..))&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">pointcut</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;pointcut()&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doBefore</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">RequestAttributes</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">getRequestAttributes</span><span class="o">();</span>
        <span class="n">ContentCachingRequestWrapper</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">ContentCachingRequestWrapper</span><span class="o">)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">resolveReference</span><span class="o">(</span><span class="n">RequestAttributes</span><span class="o">.</span><span class="na">REFERENCE_REQUEST</span><span class="o">);</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">TraceID</span><span class="o">,</span>  <span class="n">genUUID</span><span class="o">());</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">RemoteIP</span><span class="o">,</span> <span class="n">stripRemoteIP</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">LocalIP</span><span class="o">,</span> <span class="n">NetUtils</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">());</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">ReqPkg</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContentAsByteArray</span><span class="o">()));</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Ctm</span><span class="o">,</span> <span class="n">logFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@AfterReturning</span><span class="o">(</span><span class="n">pointcut</span> <span class="o">=</span> <span class="s">&#34;pointcut()&#34;</span><span class="o">,</span> <span class="n">returning</span> <span class="o">=</span> <span class="s">&#34;response&#34;</span><span class="o">)</span>
    <span class="nd">@SneakyThrows</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAfterReturning</span><span class="o">(</span><span class="n">BizResponse</span><span class="o">&lt;?&gt;</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Date</span> <span class="n">ctm</span> <span class="o">=</span> <span class="n">format</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">MDC</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Ctm</span><span class="o">));</span>
        <span class="n">Date</span> <span class="n">etm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">utm</span> <span class="o">=</span> <span class="n">etm</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">ctm</span><span class="o">.</span><span class="na">getTime</span><span class="o">();</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Etm</span><span class="o">,</span> <span class="n">format</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">etm</span><span class="o">));</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Utm</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">utm</span><span class="o">));</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">ResPkg</span><span class="o">,</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">response</span><span class="o">));</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">MDC</span><span class="o">.</span><span class="na">getCopyOfContextMap</span><span class="o">()));</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="nd">@AfterThrowing</span><span class="o">(</span><span class="n">pointcut</span> <span class="o">=</span> <span class="s">&#34;pointcut()&#34;</span><span class="o">,</span> <span class="n">throwing</span> <span class="o">=</span> <span class="s">&#34;throwable&#34;</span><span class="o">)</span>
    <span class="nd">@SneakyThrows</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAfterThrowing</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Date</span> <span class="n">ctm</span> <span class="o">=</span> <span class="n">format</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">MDC</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Ctm</span><span class="o">));</span>
        <span class="n">Date</span> <span class="n">etm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">utm</span> <span class="o">=</span> <span class="n">etm</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">ctm</span><span class="o">.</span><span class="na">getTime</span><span class="o">();</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Etm</span><span class="o">,</span> <span class="n">format</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">etm</span><span class="o">));</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Utm</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">utm</span><span class="o">));</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Exception</span><span class="o">,</span> <span class="n">throwable</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">MDC</span><span class="o">.</span><span class="na">getCopyOfContextMap</span><span class="o">()));</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>其中，关于远程ip的获取是stripRemoteIP函数，该函数尽可能获取真实的远程IP：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">String</span> <span class="nf">stripRemoteIP</span><span class="o">(</span><span class="n">ContentCachingRequestWrapper</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">forward</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&#34;X-Forwarded-For&#34;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">forward</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">&#34;unknown&#34;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">forward</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">ips</span> <span class="o">=</span> <span class="n">forward</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">ip</span> <span class="o">:</span> <span class="n">ips</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">ip</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">ip</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">realIP</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&#34;X-Real-IP&#34;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">realIP</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">&#34;unknown&#34;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">realIP</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">realIP</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteAddr</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>关于获取本地IP的函数，直接使用的是dubbo提供的NetUtils工具类，核心代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getLocalHost</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">HOST_ADDRESS</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">HOST_ADDRESS</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">InetAddress</span> <span class="n">address</span> <span class="o">=</span> <span class="n">getLocalAddress</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">address</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">HOST_ADDRESS</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="na">getHostAddress</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">LOCALHOST_VALUE</span><span class="o">;</span>
<span class="o">}</span> 

<span class="kd">public</span> <span class="kd">static</span> <span class="n">InetAddress</span> <span class="nf">getLocalAddress</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">LOCAL_ADDRESS</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">LOCAL_ADDRESS</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">InetAddress</span> <span class="n">localAddress</span> <span class="o">=</span> <span class="n">getLocalAddress0</span><span class="o">();</span>
    <span class="n">LOCAL_ADDRESS</span> <span class="o">=</span> <span class="n">localAddress</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">localAddress</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">InetAddress</span> <span class="nf">getLocalAddress0</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">InetAddress</span> <span class="n">localAddress</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// @since 2.7.6, choose the {@link NetworkInterface} first
</span><span class="c1"></span>    <span class="k">try</span> <span class="o">{</span>
        <span class="n">NetworkInterface</span> <span class="n">networkInterface</span> <span class="o">=</span> <span class="n">findNetworkInterface</span><span class="o">();</span>
        <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">InetAddress</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">networkInterface</span><span class="o">.</span><span class="na">getInetAddresses</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">addresses</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">Optional</span><span class="o">&lt;</span><span class="n">InetAddress</span><span class="o">&gt;</span> <span class="n">addressOp</span> <span class="o">=</span> <span class="n">toValidAddress</span><span class="o">(</span><span class="n">addresses</span><span class="o">.</span><span class="na">nextElement</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">addressOp</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">addressOp</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">isReachable</span><span class="o">(</span><span class="n">100</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">addressOp</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// ignore
</span><span class="c1"></span>                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">localAddress</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">();</span>
        <span class="n">Optional</span><span class="o">&lt;</span><span class="n">InetAddress</span><span class="o">&gt;</span> <span class="n">addressOp</span> <span class="o">=</span> <span class="n">toValidAddress</span><span class="o">(</span><span class="n">localAddress</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">addressOp</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">addressOp</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="k">return</span> <span class="n">localAddress</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kd">static</span> <span class="n">NetworkInterface</span> <span class="nf">findNetworkInterface</span><span class="o">()</span> <span class="o">{</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">NetworkInterface</span><span class="o">&gt;</span> <span class="n">validNetworkInterfaces</span> <span class="o">=</span> <span class="n">emptyList</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">validNetworkInterfaces</span> <span class="o">=</span> <span class="n">getValidNetworkInterfaces</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">NetworkInterface</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// Try to find the preferred one
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">NetworkInterface</span> <span class="n">networkInterface</span> <span class="o">:</span> <span class="n">validNetworkInterfaces</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isPreferredNetworkInterface</span><span class="o">(</span><span class="n">networkInterface</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">networkInterface</span><span class="o">;</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// If not found, try to get the first one
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">NetworkInterface</span> <span class="n">networkInterface</span> <span class="o">:</span> <span class="n">validNetworkInterfaces</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">InetAddress</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">networkInterface</span><span class="o">.</span><span class="na">getInetAddresses</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">addresses</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">Optional</span><span class="o">&lt;</span><span class="n">InetAddress</span><span class="o">&gt;</span> <span class="n">addressOp</span> <span class="o">=</span> <span class="n">toValidAddress</span><span class="o">(</span><span class="n">addresses</span><span class="o">.</span><span class="na">nextElement</span><span class="o">());</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">addressOp</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">addressOp</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">isReachable</span><span class="o">(</span><span class="n">100</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">networkInterface</span><span class="o">;</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// ignore
</span><span class="c1"></span>                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">first</span><span class="o">(</span><span class="n">validNetworkInterfaces</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>其中getLocalAddress0会调用findNetworkInterface找到”合适的“网卡，然后遍历、验证其中可用的ip地址并返回。 findNetworkInterface先查找用户是否通过环境变量配置了想要使用的网卡，如果没有配置则验证返回第一个”可达“网卡。</p>
<p>在dubbo服务中的日志拦截类似，不同的是我这边在实现过程中将其放到了common项目中，该项目被所有provider引用。这样我就无法针对某个特殊包特殊类特殊方法进行拦截了，只能提供相关注解，由provider在需要记录日志的方法上使用注解进行注明：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Log</span> <span class="o">{</span>
<span class="o">}</span>

<span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogAspect</span> <span class="o">{</span>
    <span class="nd">@Pointcut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;@annotation(org.xxx.aspect.Log)&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">pointcut</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;pointcut()&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doBefore</span><span class="o">(</span><span class="n">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@AfterReturning</span><span class="o">(</span><span class="n">pointcut</span> <span class="o">=</span> <span class="s">&#34;pointcut()&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAfterReturning</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">....</span>
    <span class="o">}</span>

    <span class="nd">@AfterThrowing</span><span class="o">(</span><span class="n">pointcut</span> <span class="o">=</span> <span class="s">&#34;pointcut()&#34;</span><span class="o">,</span> <span class="n">throwing</span> <span class="o">=</span> <span class="s">&#34;throwable&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAfterThrowing</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>另外，provider引用库时不会自动扫描其中的aspect路径，导致无法自动拦截打印日志。解决的方案有三种：</p>
<ul>
<li>一是手动在所有provider项目中配置@ComponentScan(&ldquo;org.xxx.aspect&rdquo;)，这样需要手动写路径，没有采用；</li>
<li>二是在common项目中额外提供EnableLog注解，所有provider项目启动类上配置@EnableLog，项目中采用该方法；</li>
<li>三是写自己的starter，这个稍微有些复杂没有采用。</li>
</ul>
<p>写EnableLog的方式如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Import</span><span class="o">(</span><span class="n">LogConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">EnableLog</span> <span class="o">{</span>
<span class="o">}</span> 

<span class="nd">@ComponentScan</span><span class="o">(</span><span class="s">&#34;org.xxx.aspect&#34;</span><span class="o">)</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogConfig</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div><p>这样就将@ComponentScan(&ldquo;org.xxx.aspect&rdquo;)这样的注解写到了common内部，封装性较好。</p>
<p>关于日志的打印位置也值得注意。一开始我将日志配置放到application.properties中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">logging.level.root=warn
logging.level.org.xxx.controller=debug
logging.level.org.xxx.aspect=info
logging.pattern.console=...
</code></pre></div><p>这样虽然可以不同的包分不同级别打印，但是无法分开打印到不同文件中。最后还是通过写logback-spring.xml解决这个问题：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&#34;CONSOLE&#34;</span> <span class="na">class=</span><span class="s">&#34;ch.qos.logback.core.ConsoleAppender&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS}%-5level [%thread] [%logger{20}] - %msg%n<span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&#34;FILE&#34;</span> <span class="na">class=</span><span class="s">&#34;ch.qos.logback.core.rolling.RollingFileAppender&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">&#34;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;fileNamePattern&gt;</span>file.%d{yyyy-MM-dd}.log<span class="nt">&lt;/fileNamePattern&gt;</span>
            <span class="nt">&lt;maxHistory&gt;</span>2<span class="nt">&lt;/maxHistory&gt;</span>
        <span class="nt">&lt;/rollingPolicy&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%-5level] - %msg%n<span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">&#34;WARN&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&#34;CONSOLE&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/root&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&#34;org.xxx.controller&#34;</span> <span class="na">additivity=</span><span class="s">&#34;false&#34;</span> <span class="na">level=</span><span class="s">&#34;INFO&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&#34;CONSOLE&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/logger&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&#34;org.xxx.aspect&#34;</span> <span class="na">additivity=</span><span class="s">&#34;false&#34;</span> <span class="na">level=</span><span class="s">&#34;INFO&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&#34;FILE&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/logger&gt;</span>
<span class="nt">&lt;/configuration&gt;</span> 
</code></pre></div><p>这样就将日志文件打印到了file.xxx.log中，而常规日志还是打印到控制台中。</p>
<h2 id="23-调用链">2.3 调用链</h2>
<p>由于一次请求会跨越多个微服务，所以有必要通过某种手段将所有调用串联起来。traceid是一个比较好的日志串联方案。对于网关来说，由于是服务入口，可以自己生成，但是dubbo服务则需要由调用者传递给提供者。我研究了一下skywalking的做法，它是对dubbo的MonitorFilter进行了拦截，将其作为入口将traceid以及其他信息附属在调用上进行传递。项目中没有采用skywalking因为其开销还是太大了，官方也建议开启采样，而业务日志最好是不采样比较好，所以我的实现还是自定义filter只传递traceid信息，做一次轻量的拦截。</p>
<p>在common模块中的resources下创建文件夹META-INF.dubbo，在此文件夹下创建文件org.apache.dubbo.rpc.Filter，并写入如下内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">logConsumer=org.xxx.dubbo.filter.ConsumerFilter
logProvider=org.xxx.dubbo.filter.ProviderFilter 
</code></pre></div><p>该文件会在dubbo启动时自动扫描到，并加载其中的filter使之生效。</p>
<p>接下来实现这两个filter:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Activate</span><span class="o">(</span><span class="n">group</span> <span class="o">=</span> <span class="n">CommonConstants</span><span class="o">.</span><span class="na">CONSUMER</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsumerFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Invoker</span><span class="o">&lt;?&gt;</span> <span class="n">invoker</span><span class="o">,</span> <span class="n">Invocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span> <span class="o">{</span>
        <span class="n">RpcContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAttachment</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">TraceID</span><span class="o">,</span> <span class="n">MDC</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">TraceID</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">invoker</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">invocation</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Activate</span><span class="o">(</span><span class="n">group</span> <span class="o">=</span> <span class="n">CommonConstants</span><span class="o">.</span><span class="na">PROVIDER</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProviderFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Invoker</span><span class="o">&lt;?&gt;</span> <span class="n">invoker</span><span class="o">,</span> <span class="n">Invocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">traceID</span> <span class="o">=</span> <span class="n">RpcContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAttachment</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">TraceID</span><span class="o">);</span>
        <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">TraceID</span><span class="o">,</span> <span class="n">traceID</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">invoker</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">invocation</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="24-监控">2.4 监控</h2>
<p>为了更好地对项目进行监控，项目后续会接入actuator暴露指标并由prometheus进行抓取监控。抓取的指标除了常规的进程、内存、cpu等信息外，还应该包括调用量、响应耗时、错误率等黄金指标。当前项目还未集成actuator ，暂不多数，后续有机会再补上。</p>
<h1 id="3-总结">3. 总结</h1>
<p>经过以上的项目配置，我觉得一个基本可用的项目框架才算是搭建完成了。当然还应该有其他应当考虑的内容，比如自动化集成和功能回归测试，后续是否还有其他未考虑到的点，还需要看自己进一步的实践了。</p>
</div>
    <div class="post-footer">
      <div class="info">
        
          <span class="separator"><a class="category" href="/categories/coding/">coding</a></span>




        

        
          <span class="separator"><a class="tag" href="/tags/java/">java</a><a class="tag" href="/tags/springboot/">springboot</a><a class="tag" href="/tags/dubbo/">dubbo</a></span>




        
      </div>
    </div>

    
  </div>


          </div>
        </div>
      </main>
    </div><footer class="footer footer--base">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2019-2021

        
      </li>
      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js"
    integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I="
    crossorigin="anonymous"
  ></script></body>
</html>
