<!DOCTYPE html>
<html class="nojs" lang="zh-cn" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>在k8s集群中部署mysql – psycode - better code, better life.</title>
<meta name="description" content="本篇文章参考了官方kubenetes部署mysql的过程，对如何在k8s环境下安装mysql进行了实践。 首先快速安装一个只有master节点的mysql实例，先有个直观印象。 使用如下yaml: apiVersion: v1 kind: ConfigMap metadata: name: mysql namespace: mysql …">
<meta name="created" content="2021-01-23T00:13:56+0800">
<meta name="modified" content="2021-01-23T00:13:56+0800">
<meta name="author" content="psycode">
<meta name="contact" content="psyucc@163.com">
<meta property="og:site_name" content="psycode - better code, better life.">
<meta property="og:title" content="在k8s集群中部署mysql">
<meta property="og:url" content="https://sh1yu.github.io/post/install-mysql-in-k8s/">
<meta property="og:type" content="article">

<meta name="generator" content="Hugo 0.87.0" />
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="theme-color" content="#ffffff">


<link rel="canonical" href="https://sh1yu.github.io/post/install-mysql-in-k8s/">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<link rel="stylesheet" href="/css/mobile.2ab74aa64785dcab8114959e76ca140cf76207cd85989bc6d4fc3b12f734a09e.css" media="screen">
<link rel="stylesheet" href="/css/styles.220f12cbeefa3ca61dd63c4390295bf3974c4ba9557837d5e408db1b40a477ee.css">
<link rel="stylesheet" href="/css/print.27fc184f8670f41a2690985390779e7b20335a8fadff8fa015cf9417ffe50c36.css" media="print">

<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "在k8s集群中部署mysql",
    "datePublished": "2021-01-23T00:13:56+08:00",
    "dateModified": "2021-01-23T00:13:56+08:00",
    "url" : "https://sh1yu.github.io/post/install-mysql-in-k8s/",
    "description": "本篇文章参考了官方kubenetes部署mysql的过程，对如何在k8s环境下安装mysql进行了实践。 首先快速安装一个只有master节点的mysql实例，先有个直观印象。 使用如下yaml: apiVersion: v1 kind: ConfigMap metadata: name: mysql namespace: mysql …",
    "keywords": ["k8s","mysql"],
    "author": {
      "@type": "Person",
      "name": "psycode"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://sh1yu.github.io"
    },
    "publisher": {
      "@type": "Organization",
      "name": "psycode - better code, better life.",
      "url": "https://sh1yu.github.io"
    }
  }
</script>

<script src="/js/script-early.min.3b0e641814c87f6a1d6ffa5e7d597f29faa8ce11482541e8801dc34013817c91.js"></script>
<script defer src="/js/lib/jquery.slim.min.bbb7b9921ca2b61948753a6edb63c78443663dc45d1621d18e102e1dcb34e512.js"></script>
<script defer src="/js/lib/umbrella.min.6e17830ccdded0a13b96d6993865b58202bc2ee750e5892a51858ab048b2bebb.js"></script>
<script defer src="/js/mobile.min.abb9438113cb72181ecda30b9375cc0771c7ce2e7354414a7c1296b45cf47135.js"></script>
<script src="/js/lib/js.cookie.min.31d1799663bbb6029214d90ba7db9cdc725fa02c16d4b090add3721e44238b6b.js"></script>
<script defer src="/js/cookieconsent.min.21a8d7c181aecb9bb5b91b2e1735d9fd9d283a8a752e9dcdf33c052137987f2b.js"></script>
<script defer src="/js/script.min.c2752732454d16255cfd30375b9a3e48a37b7b809c917b33920889c859ba1300.js"></script>


</head>

<body class="single-page">
<div class="page layout__page layout__sidebar-second">
<header class="header layout__header">

<h1 class="header__site-name">
<a href="/" title="Home" class="header__site-link" rel="home"><span>psycode - better code, better life.</span></a>
</h1>
<div class="region header__region">
</div>
</header>

<nav class="main-menu layout__navigation">
<h2 class="visually-hidden">Main menu</h2>
<ul class="navbar">
<li><a href="/">Home</a></li>
<li><a href="/post/" class="active" aria-current="page">Posts</a></li>
</ul>
</nav>


<main class="main layout__main">
<article class="section-post single-view">
<header>
<h1 class="title title-submitted">在k8s集群中部署mysql</h1>
<div class="submitted">
<span class="author" itemprop="author">psycode</span> - <time class="created-date" datetime="2021-01-23T00:13:56&#43;08:00">23 January, 2021</time>
</div>
<div class="tags">
Tags:
<ul>
<li><a href="/tags/k8s">k8s</a></li>
<li><a href="/tags/mysql">mysql</a></li>
</ul>
</div>
</header>
<div class="content">
<p>本篇文章参考了官方kubenetes部署mysql的过程，对如何在k8s环境下安装mysql进行了实践。
首先快速安装一个只有master节点的mysql实例，先有个直观印象。
使用如下yaml:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">mysql</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">mysql</span>
<span style="color:#f92672">data</span>:
  <span style="color:#f92672">master.cnf</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    [mysqld]
</span><span style="color:#e6db74">    log-bin</span>    

---

<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">mysql</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">mysql</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">mysql</span>

---

<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">mysql</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">mysql</span>
  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">mysql</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">mysql</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">initContainers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">init-mysql</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mysql:5.7</span>
        <span style="color:#f92672">command</span>:
        - <span style="color:#ae81ff">bash</span>
        - <span style="color:#e6db74">&#34;-c&#34;</span>
        - |<span style="color:#e6db74">
</span><span style="color:#e6db74">          set -ex
</span><span style="color:#e6db74">          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
</span><span style="color:#e6db74">          ordinal=${BASH_REMATCH[1]}
</span><span style="color:#e6db74">          echo [mysqld] &gt; /mnt/conf.d/server-id.cnf
</span><span style="color:#e6db74">          echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf
</span><span style="color:#e6db74">          if [[ $ordinal -eq 0 ]]; then
</span><span style="color:#e6db74">            cp /mnt/config-map/master.cnf /mnt/conf.d/
</span><span style="color:#e6db74">          fi</span>          
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">conf</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/mnt/conf.d</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config-map</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/mnt/config-map</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mysql:5.7</span>
        <span style="color:#f92672">env</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD</span>
          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">3306</span>
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/mysql</span>
          <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">mysql</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">conf</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/mysql/conf.d</span>
        <span style="color:#f92672">resources</span>:
          <span style="color:#f92672">requests</span>:
            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1Gi</span>
        <span style="color:#f92672">livenessProbe</span>:
          <span style="color:#f92672">exec</span>:
            <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;mysqladmin&#34;</span>, <span style="color:#e6db74">&#34;ping&#34;</span>]
          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">30</span>
          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
        <span style="color:#f92672">readinessProbe</span>:
          <span style="color:#f92672">exec</span>:
            <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;mysql&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#e6db74">&#34;-e&#34;</span>, <span style="color:#e6db74">&#34;SELECT 1&#34;</span>]
          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">2</span>
          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
      <span style="color:#f92672">volumes</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">conf</span>
        <span style="color:#f92672">emptyDir</span>: {}
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config-map</span>
        <span style="color:#f92672">configMap</span>:
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
  <span style="color:#f92672">volumeClaimTemplates</span>:
  - <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data</span>
      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">mysql</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">accessModes</span>: [<span style="color:#e6db74">&#34;ReadWriteOnce&#34;</span>]
      <span style="color:#f92672">storageClassName</span>: <span style="color:#e6db74">&#34;standard&#34;</span>
      <span style="color:#f92672">resources</span>:
        <span style="color:#f92672">requests</span>:
          <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi</span>

</code></pre></div><p>如果集群中没有<code>standard</code>这个StorageClass，使用如下配置localPV的storageClass:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-pv</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">capacity</span>:
    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi</span>
  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span>
  <span style="color:#f92672">accessModes</span>:
  - <span style="color:#ae81ff">ReadWriteOnce</span>
  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Delete</span>
  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">local-storage</span>
  <span style="color:#f92672">local</span>:
    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/data/localpv1</span>
  <span style="color:#f92672">nodeAffinity</span>:
    <span style="color:#f92672">required</span>:
      <span style="color:#f92672">nodeSelectorTerms</span>:
      - <span style="color:#f92672">matchExpressions</span>:
        - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
          <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
          <span style="color:#f92672">values</span>:
          - <span style="color:#ae81ff">k8s-node-135</span>

---

<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StorageClass</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">local-storage</span>
<span style="color:#f92672">provisioner</span>: <span style="color:#ae81ff">kubernetes.io/no-provisioner</span>
<span style="color:#f92672">volumeBindingMode</span>: <span style="color:#ae81ff">WaitForFirstConsumer</span>
</code></pre></div><p>由于使用了<code>Headless Service</code>，集群会自动在DNS解析中添加<code>&lt;pod name&gt;.&lt;service name&gt;</code>的域名解析，直接解析到对应pod。
比如<code>pod name</code>为<code>mysql-0</code>，<code>service name</code>为<code>mysql</code>，在相同命名空间下的集群内的程序可以使用<code>mysql-0.mysql</code>直接访问到pod。如果是外部命名空间访问，需要将命名空间也带上，比如<code>mysql-0.mysql.mysql</code>。</p>


<aside class="related layout__related">
<h2>See also</h2>
<ul>
<li><a href="/post/kubernetes-statefulset/">kubernetes之StatefulSet</a></li>
</ul>
</aside>
</div>
</article>
</main>


<aside class="sidebar layout__second-sidebar">
<section>
<h4 class="menu"><a href="/post/" class="active" aria-current="page">Posts</a></h4>
<ul class="menu">
<li><a href="/post/golang%E7%BB%84%E5%90%88%E6%8E%A5%E5%8F%A3%E4%BB%A5%E5%8F%8A%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">golang组合、接口以及反序列化</a></li>
<li><a href="/post/%E4%B8%80%E6%AC%A1springboot&#43;dubbo%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">一次springboot&#43;dubbo的项目实战</a></li>
<li><a href="/post/vscode%E9%85%8D%E7%BD%AEcpp%E5%A4%96%E9%83%A8%E5%A4%B4%E6%96%87%E4%BB%B6%E4%BE%9D%E8%B5%96/">Vscode配置cpp外部头文件依赖</a></li>
<li><a href="/post/install-mysql-in-k8s/" class="active" aria-current="page">在k8s集群中部署mysql</a></li>
<li><a href="/post/sign-model/">SIGN模型找到天赋</a></li>
<li><a href="/post/knowledge-to-ability/">将知识内化成能力</a></li>
<li><a href="/post/iceberg-model/">冰山模型</a></li>
<li><a href="/post/kubernetes-statefulset/">kubernetes之StatefulSet</a></li>
<li><a href="/post/vert.x-and-future/">Vert.x线程与Future</a></li>
<li><a href="/post/archlinux-operation/">archlinux使用操作拾遗</a></li>
<li><a href="/post/run-gogs-with-docker/">使用docker运行gogs服务</a></li>
</ul>
</section>
</aside>
<footer class="footer layout__footer">
<p>This site is licensed under a (<a href="https://creativecommons.org/licenses/by-sa/4.0/)">https://creativecommons.org/licenses/by-sa/4.0/)</a>. [Creative Commons Attribution-ShareAlike 4.0 International License]</p>
<p>A <a href="https://example.org/">example.org</a> production.</p>
<p>Powered by <a href="https://gohugo.io/">Hugo</a> and the <a href="https://github.com/frjo/hugo-theme-zen">Zen theme</a>.</p>
</footer>
<div class="cookieconsent layout__cookieconsent hidden">
  <div class="cookieconsent__message">
    This website uses non essential cookies for tracking and analytics that you can accept or decline.
    
  </div>
  <div class="cookieconsent__actions">
    <button class="button button--small button--cookieconsent button--decline" type="button" data-consent="false">Decline tracking</button>
    <button class="button button--small button--cookieconsent button--accept" type="button" data-consent="true">Accept tracking</button>
  </div>
</div>
</div>
<div class="mobile-nav" dir="ltr">
  <div class="mobile-nav__cover"></div>
  <a href="#navigation" class="mobile-nav__toggle" aria-haspopup="true" role="button">Menu</a>
  <div class="mobile-nav__sheet">
    <div class="mobile-nav__region">
    
    </div>
    <nav class="mobile-nav__main-menu">
    <h2 class="visually-hidden">Main menu</h2>
    <ul class="mobile-nav__navbar">
    <li><a href="/">Home</a></li>
    <li><a href="/post/" class="active" aria-current="page">Posts</a></li>
    </ul>
    </nav>
  </div>
</div>
</body>
</html>
