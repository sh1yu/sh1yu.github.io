<!DOCTYPE html>
<html
  dir="ltr"
  lang="zh-cn"
  data-theme="light"
><head>
  <title>
    psycode
      |
      golang组合、接口以及反序列化


    

  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.87.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta
    name="description"
    content="
      better code, better life.


    "
  />
  
  
  
  <link
    rel="stylesheet"
    href="/css/main.min.62c68e6209f6e0ad6a21a6c89488202f1ac09c13fc07856ebd509ecd54ab3196.css"
    integrity="sha256-YsaOYgn24K1qIabIlIggLxrAnBP8B4VuvVCezVSrMZY="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.8e4c8f0a940b1596fb4c64d28a00a5ceed671fc303cb65178b4947417da9c674.css"
    integrity="sha256-jkyPCpQLFZb7TGTSigClzu1nH8MDy2UXi0lHQX2pxnQ="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
    crossorigin="anonymous"
  />
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

  <link rel="canonical" href="/post/golang%E7%BB%84%E5%90%88%E6%8E%A5%E5%8F%A3%E4%BB%A5%E5%8F%8A%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.2a2cd9614b7d007dfbb75e8da19e3a0fa872ceab53c6d000c00b7a0c89b85bfc.js"
    integrity="sha256-KizZYUt9AH37t16NoZ46D6hyzqtTxtAAwAt6DIm4W/w="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js"
      integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus="
      crossorigin="anonymous"
    ></script>

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="golang组合、接口以及反序列化"/>
<meta name="twitter:description" content="现在，我想用Go实现一个Event类，有如下的要求：
 有多种Event类型，不同的Event类型拥有不同的参数； 这些Event会被持久化到存储中，在需要时反序列化回来； 每个Event都有Process方法，具体的方法实现逻辑存放在不同的Event具体类型中。  ok，看需求并不复杂，不就是面向对象的继承、重载那一套吗，so easy，直接开搞！ 但是真正实现时，才发现没有想象中的那么简单&hellip;
1. 结构体实现 首先我们使用go来实现结构体Event，然后利用组合的方式实现两个Event:"/>



  


  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "post",
        "name": "golang组合、接口以及反序列化",
        "headline": "golang组合、接口以及反序列化",
        "alternativeHeadline": "",
        "description": "
      
        现在，我想用Go实现一个Event类，有如下的要求：\n 有多种Event类型，不同的Event类型拥有不同的参数； 这些Event会被持久化到存储中，在需要时反序列化回来； 每个Event都有Process方法，具体的方法实现逻辑存放在不同的Event具体类型中。  ok，看需求并不复杂，不就是面向对象的继承、重载那一套吗，so easy，直接开搞！ 但是真正实现时，才发现没有想象中的那么简单\u0026hellip;\n1. 结构体实现 首先我们使用go来实现结构体Event，然后利用组合的方式实现两个Event:


      


    ",
        "inLanguage": "zh-cn",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/sh1yu.github.io\/post\/golang%E7%BB%84%E5%90%88%E6%8E%A5%E5%8F%A3%E4%BB%A5%E5%8F%8A%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96\/"
        },
        "author" : {
            "@type": "Person",
            "name": "psycode"
        },
        "creator" : {
            "@type": "Person",
            "name": "psycode"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "psycode"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "psycode"
        },
        "copyrightYear" : "2021",
        "dateCreated": "2021-09-04T19:35:00.00Z",
        "datePublished": "2021-09-04T19:35:00.00Z",
        "dateModified": "2021-09-04T19:35:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "psycode",
            "url": "https://sh1yu.github.io",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/sh1yu.github.iofavicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/sh1yu.github.io\/post\/golang%E7%BB%84%E5%90%88%E6%8E%A5%E5%8F%A3%E4%BB%A5%E5%8F%8A%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96\/",
        "wordCount" : "1171",
        "genre" : [ 
      
      "coding"

    ],
        "keywords" : [ 
      
      "go"

    ]
    }
  </script>



</head>
<body>
    <header><div
  class="page-top 
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
  </a>
  <nav>
    <ul class="nav__list" id="navMenu">
      <div class="nav__links">
        
        
          
          <li>
            <a
              
              href="/"
              
              title=""
              >主页</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/post/"
              
              title=""
              >文章</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/about/"
              
              title=""
              >关于我</a
            >
          </li>

        
        
      </div>
      <li>
        
          <a class="theme-switch" title="Switch Theme">
            <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
          </a>

        
      </li>
    </ul>
  </nav>
</div>
</header>
    <div class="wrapper">
      <aside><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="logo-title">
      <div class="title">
        <img src="https://avatars.githubusercontent.com/u/4922741?s=400&amp;u=c325c94d790c852dca971de31d50d93dc50a1e74&amp;v=4" alt="profile picture" />
        <h3 title=""><a href="/">psy&#39;s code</a></h3>
        <div class="description">
          <p>better code, better life.</p>
        </div>
      </div>
    </div>
    <ul class="social-links">
      
    </ul>
  </div><footer class="footer footer--sidebar">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2019-2021

        
      </li>
      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js"
    integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main>
        <div class="autopagerize_page_element">
          <div class="content">
  <div
    class="post 
      animated fadeInDown

    "
  >
    <div class="post-content">
      
      <div class="post-title">
        <h1>golang组合、接口以及反序列化</h1>
        
          <div class="info">
            <em class="fas fa-calendar-day"></em>
            <span class="date"
              >
                Sat, Sep 4, 2021


              </span
            >
            <em class="fas fa-stopwatch"></em>
            <span class="reading-time">阅读时间 6 分钟</span>
          </div>

        
      </div><p>现在，我想用Go实现一个<code>Event</code>类，有如下的要求：</p>
<ol>
<li>有多种Event类型，不同的Event类型拥有不同的参数；</li>
<li>这些Event会被持久化到存储中，在需要时反序列化回来；</li>
<li>每个Event都有Process方法，具体的方法实现逻辑存放在不同的Event具体类型中。</li>
</ol>
<p>ok，看需求并不复杂，不就是面向对象的继承、重载那一套吗，so easy，直接开搞！
但是真正实现时，才发现没有想象中的那么简单&hellip;</p>
<h2 id="1-结构体实现">1. 结构体实现</h2>
<p>首先我们使用go来实现结构体<code>Event</code>，然后利用<strong>组合</strong>的方式实现两个<code>Event</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Event</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">EventType</span> <span class="kt">string</span> <span class="s">`json:&#34;event_type&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ClickEvent</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Event</span> <span class="s">`json:&#34;,inline&#34;`</span>
	<span class="nx">OnPosX</span> <span class="kt">int64</span> <span class="s">`json:&#34;on_pos_x&#34;`</span>
	<span class="nx">OnPosY</span> <span class="kt">int64</span> <span class="s">`json:&#34;on_pos_y&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">DragEvent</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Event</span> <span class="s">`json:&#34;,inline&#34;`</span>
	<span class="nx">OnPosX</span> <span class="kt">int64</span> <span class="s">`json:&#34;on_pos_x&#34;`</span>
	<span class="nx">OnPosY</span> <span class="kt">int64</span> <span class="s">`json:&#34;on_pos_y&#34;`</span>
	<span class="nx">ToPosX</span> <span class="kt">int64</span> <span class="s">`json:&#34;to_pos_x&#34;`</span>
	<span class="nx">ToPosY</span> <span class="kt">int64</span> <span class="s">`json:&#34;to_pos_y&#34;`</span>
<span class="p">}</span>
</code></pre></div><p>很简单，没有问题。</p>
<h2 id="2-序列化与反序列化">2. 序列化与反序列化</h2>
<p>让我们尝试将其序列化到json，以便持久化存储：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">event1</span> <span class="o">:=</span> <span class="nx">ClickEvent</span><span class="p">{</span>
		<span class="nx">Event</span><span class="p">:</span>  <span class="nx">Event</span><span class="p">{</span><span class="nx">EventType</span><span class="p">:</span> <span class="s">&#34;click&#34;</span><span class="p">},</span>
		<span class="nx">OnPosX</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">OnPosY</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">b1</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">event1</span><span class="p">)</span>

	<span class="nx">event2</span> <span class="o">:=</span> <span class="nx">DragEvent</span><span class="p">{</span>
		<span class="nx">Event</span><span class="p">:</span>  <span class="nx">Event</span><span class="p">{</span><span class="nx">EventType</span><span class="p">:</span> <span class="s">&#34;drag&#34;</span><span class="p">},</span>
		<span class="nx">OnPosX</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
		<span class="nx">OnPosY</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
		<span class="nx">ToPosX</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
		<span class="nx">ToPosY</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">b2</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">event2</span><span class="p">)</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b1</span><span class="p">))</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b2</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div><p>看上去也不难。对每个具体的Event直接json反序列化即可。以上程序会输出如下的序列化之后的字符串：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;event_type&#34;</span><span class="p">:</span><span class="s2">&#34;click&#34;</span><span class="p">,</span><span class="nt">&#34;on_pos_x&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&#34;on_pos_y&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&#34;event_type&#34;</span><span class="p">:</span><span class="s2">&#34;drag&#34;</span><span class="p">,</span><span class="nt">&#34;on_pos_x&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&#34;on_pos_y&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&#34;to_pos_x&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="nt">&#34;to_pos_y&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">}</span>
</code></pre></div><p>那如果反序列化呢？</p>
<p>为了使程序更加通用，我们假设并不清楚读取得到的json究竟是哪一种事件类型。一般会有一个函数能反序列化所有的事件类型，根据其中的<code>EventType</code>类型不同反序列化成不同的事件类型的实例。</p>
<p>让我们先试试直接反序列化成组合的根结构体会怎么样？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">jsonStr</span> <span class="o">:=</span> <span class="s">`{&#34;event_type&#34;:&#34;click&#34;,&#34;on_pos_x&#34;:10,&#34;on_pos_y&#34;:20}`</span>
	<span class="nx">event</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">unmarshalEvent</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v\n&#34;</span><span class="p">,</span> <span class="nx">event</span><span class="p">)</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">event</span><span class="p">.(</span><span class="o">*</span><span class="nx">ClickEvent</span><span class="p">).</span><span class="nx">OnPosX</span><span class="p">)</span> <span class="c1">//备注2
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">unmarshalEvent</span><span class="p">(</span><span class="nx">jStr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Event</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tmpEvent</span> <span class="nx">Event</span> <span class="c1">// //备注1
</span><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">tmpEvent</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">tmpEvent</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></div><p>在<em>备注2</em>的位置我们遇到了麻烦。这里json从类型上看是<code>ClickEvent</code>类型，但是使用组合结构体<code>Event</code>进行反序列化之后并没有得到想要的类型。该<code>Event</code>无法强制转换为<code>ClickEvent</code>类型，就算<code>ClickEvent</code>中组合了<code>Event</code>也不行。我们需要另想办法。</p>
<p>需要注意的是，以上程序报的错误是</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">invalid type assertion: tmpEvent.(*ClickEvent) (non-interface type Event on left)
</code></pre></div><p>这里似乎说的是<em>备注1</em>的位置没有使用<code>interface{}</code>导致的该问题。但是就算改成了<code>var tmpEvent interface{}</code>, 也依旧会报错，变成如下错误：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">panic: interface conversion: interface {} is map[string]interface {}, not *main.ClickEvent
</code></pre></div><p>也就是说json直接被反序列化成了<code>map[string]interface {}</code>，似乎更糟了。</p>
<p>这里有一种解决方案，就是在<code>unmarshalEvent</code>函数中先反序列化为<code>Event</code>，然后再根据其类型反序列化为其他类型。代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">jsonStr</span> <span class="o">:=</span> <span class="s">`{&#34;event_type&#34;:&#34;click&#34;,&#34;on_pos_x&#34;:10,&#34;on_pos_y&#34;:20}`</span>
	<span class="nx">event</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">unmarshalEvent</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="c1">//备注2
</span><span class="c1"></span>	<span class="k">switch</span> <span class="nx">event</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//备注3
</span><span class="c1"></span>	<span class="k">case</span> <span class="o">*</span><span class="nx">ClickEvent</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">event</span><span class="p">.(</span><span class="o">*</span><span class="nx">ClickEvent</span><span class="p">).</span><span class="nx">OnPosX</span><span class="p">)</span>
	<span class="k">case</span> <span class="o">*</span><span class="nx">DragEvent</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">event</span><span class="p">.(</span><span class="o">*</span><span class="nx">DragEvent</span><span class="p">).</span><span class="nx">ToPosX</span><span class="p">)</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="c1">// todo more judge
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">unmarshalEvent</span><span class="p">(</span><span class="nx">jStr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tmpEvent</span> <span class="nx">Event</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">tmpEvent</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="nx">tmpEvent</span><span class="p">.</span><span class="nx">EventType</span> <span class="p">{</span> <span class="c1">// 备注1
</span><span class="c1"></span>	<span class="k">case</span> <span class="s">&#34;click&#34;</span><span class="p">:</span>
		<span class="kd">var</span> <span class="nx">clickEvent</span> <span class="nx">ClickEvent</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">clickEvent</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">clickEvent</span><span class="p">,</span> <span class="nx">err</span>
	<span class="k">case</span> <span class="s">&#34;drag&#34;</span><span class="p">:</span>
		<span class="kd">var</span> <span class="nx">dragEvent</span> <span class="nx">DragEvent</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">dragEvent</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">dragEvent</span><span class="p">,</span> <span class="nx">err</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="c1">//todo another type
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;invalid type:&#34;</span> <span class="o">+</span> <span class="nx">tmpEvent</span><span class="p">.</span><span class="nx">EventType</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>代码可以正常运行，我们成功地识别出了json中的<code>Event</code>类型，并将其反序列化成了想要的具体类型。
由<em>备注2</em>的输出可以看到，我们得到的类型的确是<code>*ClickEvent</code>，而不是<code>*Event</code>。</p>
<p>这里有两个问题：</p>
<ol>
<li>我们需要再反序列化时枚举所有可能的<code>Event</code>类型。也就是说每当我需要新增一个<code>Event</code>类型，都需要修改<em>备注1</em>的代码，不符合开闭原则；</li>
<li>由于go无法在组合结构体之间相互赋值，<code>unmarshalEvent</code>的返回类型是一个<code>interface{}</code>，这样就无可避免地需要在<em>备注3</em>处进行类型判断和类型强转，导致代码冗长。</li>
</ol>
<p>第一个问题我们暂时先放一放；对于第二个问题，我们能否使用接口来解决？</p>
<h2 id="3-使用接口实现扩展">3. 使用接口实现扩展</h2>
<p>我们修改一下第1节的结构体定义，改成使用接口而非组合的方式进行<code>Event</code>的扩展：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Event</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">GetEventType</span><span class="p">()</span> <span class="kt">string</span>
	<span class="nf">Process</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ClickEvent</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">OnPosX</span> <span class="kt">int64</span> <span class="s">`json:&#34;on_pos_x&#34;`</span>
	<span class="nx">OnPosY</span> <span class="kt">int64</span> <span class="s">`json:&#34;on_pos_y&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ClickEvent</span><span class="p">)</span> <span class="nf">GetEventType</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="s">&#34;click&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ClickEvent</span><span class="p">)</span> <span class="nf">Process</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;process ClickEvent with on pos: &#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">OnPosX</span><span class="p">,</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">OnPosY</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ClickEvent</span><span class="p">)</span> <span class="nf">MarshalJSON</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">type</span> <span class="nx">copyType</span> <span class="nx">ClickEvent</span>
	<span class="k">return</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="kd">struct</span> <span class="p">{</span>
		<span class="nx">copyType</span>
		<span class="nx">EventType</span> <span class="kt">string</span> <span class="s">`json:&#34;event_type&#34;`</span>
	<span class="p">}{</span>
		<span class="nx">copyType</span><span class="p">:</span>  <span class="nf">copyType</span><span class="p">(</span><span class="o">*</span><span class="nx">e</span><span class="p">),</span>
		<span class="nx">EventType</span><span class="p">:</span> <span class="s">&#34;click&#34;</span><span class="p">,</span>
	<span class="p">})</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">DragEvent</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">OnPosX</span> <span class="kt">int64</span> <span class="s">`json:&#34;on_pos_x&#34;`</span>
	<span class="nx">OnPosY</span> <span class="kt">int64</span> <span class="s">`json:&#34;on_pos_y&#34;`</span>
	<span class="nx">ToPosX</span> <span class="kt">int64</span> <span class="s">`json:&#34;to_pos_x&#34;`</span>
	<span class="nx">ToPosY</span> <span class="kt">int64</span> <span class="s">`json:&#34;to_pos_y&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">DragEvent</span><span class="p">)</span> <span class="nf">GetEventType</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="s">&#34;drag&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">DragEvent</span><span class="p">)</span> <span class="nf">Process</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;process DragEvent with to pos: &#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ToPosX</span><span class="p">,</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ToPosY</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">DragEvent</span><span class="p">)</span> <span class="nf">MarshalJSON</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">type</span> <span class="nx">copyType</span> <span class="nx">DragEvent</span>
	<span class="k">return</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="kd">struct</span> <span class="p">{</span>
		<span class="nx">copyType</span>
		<span class="nx">EventType</span> <span class="kt">string</span> <span class="s">`json:&#34;event_type&#34;`</span>
	<span class="p">}{</span>
		<span class="nx">copyType</span><span class="p">:</span>  <span class="nf">copyType</span><span class="p">(</span><span class="o">*</span><span class="nx">e</span><span class="p">),</span>
		<span class="nx">EventType</span><span class="p">:</span> <span class="s">&#34;drag&#34;</span><span class="p">,</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></div><p>在这里，<code>Event</code>变成了一个接口而非结构体，除了提供<code>GetEventType</code>方法之外，也定义了必须实现的<code>Process</code>方法。注意其中为了保证序列化结果中包含<code>event_type</code>，这里重新定义了<code>ClickEvent</code>和<code>DragEvent</code>的<code>MarshalJSON</code>方法。</p>
<p>使用接口的方式实现的各个事件定义的序列化的使用方式和之前没有什么不同，这里直接看反序列化:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">jsonStr</span> <span class="o">:=</span> <span class="s">`{&#34;event_type&#34;:&#34;click&#34;,&#34;on_pos_x&#34;:10,&#34;on_pos_y&#34;:20}`</span>
	<span class="nx">event</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">unmarshalEvent</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> 
	<span class="k">switch</span> <span class="nx">event</span><span class="p">.</span><span class="nf">GetEventType</span><span class="p">()</span> <span class="p">{</span> <span class="c1">//备注3
</span><span class="c1"></span>	<span class="k">case</span> <span class="s">&#34;click&#34;</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">event</span><span class="p">.(</span><span class="o">*</span><span class="nx">ClickEvent</span><span class="p">).</span><span class="nx">OnPosX</span><span class="p">)</span>
	<span class="k">case</span> <span class="s">&#34;drag&#34;</span><span class="p">:</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">event</span><span class="p">.(</span><span class="o">*</span><span class="nx">DragEvent</span><span class="p">).</span><span class="nx">ToPosX</span><span class="p">)</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="c1">// todo more judge
</span><span class="c1"></span>	<span class="p">}</span>

    <span class="nx">event</span><span class="p">.</span><span class="nf">Process</span><span class="p">()</span> <span class="c1">//备注4
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">unmarshalEvent</span><span class="p">(</span><span class="nx">jStr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Event</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tmpEvent</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span> <span class="c1">// 备注1
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">tmpEvent</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="nx">tmpEvent</span><span class="p">[</span><span class="s">&#34;event_type&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 备注2
</span><span class="c1"></span>	<span class="k">case</span> <span class="s">&#34;click&#34;</span><span class="p">:</span>
		<span class="kd">var</span> <span class="nx">clickEvent</span> <span class="nx">ClickEvent</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">clickEvent</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">clickEvent</span><span class="p">,</span> <span class="nx">err</span>
	<span class="k">case</span> <span class="s">&#34;drag&#34;</span><span class="p">:</span>
		<span class="kd">var</span> <span class="nx">dragEvent</span> <span class="nx">DragEvent</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">dragEvent</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">dragEvent</span><span class="p">,</span> <span class="nx">err</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="c1">//todo another type
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;invalid type:&#34;</span> <span class="o">+</span> <span class="nx">tmpEvent</span><span class="p">[</span><span class="s">&#34;event_type&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div><p>这里将<code>unmarshalEvent</code>方法的返回值类型由<code>interface</code>变更为了<code>Event</code>。代价就是在判断当前事件类型时不能使用<code>Event</code>接收反序列化结果了，<em>备注1</em>处和<em>备注2</em>处必须使用<code>map[string]interface{}</code>，稍微复杂了些。</p>
<p>在<em>备注3</em>处，为了获取原始的事件，还是需要进行类型的探测以及强转，不过这里好一点的是无需进行类型检测，只需要检测<code>event.GetEventType()</code>即可。另外在<em>备注4</em>处，我们可以无需进行类型探测和强转即可去调用各个实现事件的<code>Process</code>函数，这个就比之前使用<code>interface{}</code>的方式好很多。这真是接口&quot;抽象行为&quot;上的优势体现。但是使用接口的方式问题在于无法提取共性的参数进行复用，可以结合使用&quot;组合&quot;和&quot;接口&quot;两种方式来获取二者的优势。</p>
<h2 id="4-支持自定义的事件">4. 支持自定义的事件</h2>
<p>到目前为止看来问题几乎已经完全得到了解决，除了上一章提到的一个问题：</p>
<blockquote>
<p>我们需要再反序列化时枚举所有可能的<code>Event</code>类型。也就是说每当我需要新增一个<code>Event</code>类型，都需要修改<em>备注1</em>的代码，不符合开闭原则。</p>
</blockquote>
<p>在我们需要支持用户自定义事件时，每次新增都需要修改一次<code>unmarshalEvent</code>的函数代码。这个该怎么改进呢？</p>
<p>退一步想一下，如果我自定义了一个事件，然后在<code>unmarshalEvent</code>中反序列化一个json成为这个自定义事件的类型实例，需要哪些必要的信息？</p>
<p>首先很明确的一点，就是当前提供的json具体是哪个类型，这个信息通过字段<code>event_type</code>已经可以知道了；其次，如果是自定义的扩展类型，还需要的数据就是“当前扩展类型的结构体定义”，或者说有一种机制能够让<code>unmarshalEvent</code>在读取到<code>event_type</code>之后还能够知道这种<code>event_type</code>对应的类型就行了。</p>
<p>这样看的话，我们可以为<code>unmarshalEvent</code>函数维护一个可以扩展的映射，维护<code>event_type</code>到具体结构体类型的映射关系。在我们新增一个<code>event_type</code>及其定义时，将其注册到这个扩展映射中即可。这样的话在事件类型扩展时<code>unmarshalEvent</code>本身不用做任何改动。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">mutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="kd">var</span> <span class="nx">extendEventType</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span>

<span class="kd">func</span> <span class="nf">RegisterExtendEvent</span><span class="p">(</span><span class="nx">eventType</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">p</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">extendEventType</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">extendEventType</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">extendEventType</span><span class="p">[</span><span class="nx">eventType</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">GetEventByType</span><span class="p">(</span><span class="nx">eventType</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">mutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">mutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">extendEventType</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">extendEventType</span><span class="p">[</span><span class="nx">eventType</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;Unregistered extendEventType:&#34;</span> <span class="o">+</span> <span class="nx">eventType</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">extendEventType</span><span class="p">[</span><span class="nx">eventType</span><span class="p">],</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">unmarshalEvent</span><span class="p">(</span><span class="nx">jStr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Event</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tmpEvent</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">tmpEvent</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">eventType</span> <span class="o">:=</span> <span class="nx">tmpEvent</span><span class="p">[</span><span class="s">&#34;event_type&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">GetEventByType</span><span class="p">(</span><span class="nx">eventType</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">extendEvent</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">).</span><span class="nf">Interface</span><span class="p">()</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">extendEvent</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">extendEvent</span><span class="p">.(</span><span class="nx">Event</span><span class="p">),</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></div><p>然后再需要扩展<code>Event</code>类型时进行注册即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nf">RegisterExtendEvent</span><span class="p">(</span><span class="s">&#34;click&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">ClickEvent</span><span class="p">{}))</span>
<span class="nf">RegisterExtendEvent</span><span class="p">(</span><span class="s">&#34;drag&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">DragEvent</span><span class="p">{}))</span>
</code></pre></div><p>到目前为止，我们似乎完成了所有的需求。看上去不错，但这里有一个限制就是<code>unmarshalEvent()</code>结果获取的是<code>Event</code>接口，也就是说我们可以调用其中的接口方法，但是无法调用实际类型的方法（强制转换后是可以的，但是还是需要switch判断实际类型后进行转换，不是我所需要的）。</p>
<p>假如我们需要的通用操作不只是<code>Process()</code>，需要扩展一个新的操作<code>Cancel()</code>，这个时候只有两种办法：
要么修改<code>Event</code>接口定义然后实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Event</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">GetEventType</span><span class="p">()</span> <span class="kt">string</span>
	<span class="nf">Process</span><span class="p">()</span>
	<span class="nf">Cancel</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div><p>要么我重新定义一个<code>Canceler</code>接口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Canceler</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Cancel</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div><p>重新定义一个<code>Canceler</code>接口是不合适的，<code>unmarshalEvent()</code>无法返回多个接口的变量，毕竟没有泛型；而如果我修改<code>Event</code>接口定义，那么我需要修改所有的<code>Event</code>实现，这工作量也太大了些。</p>
<p>参考接口类型的注册模式，我们也可以定义一个不同操作的注册机制。<code>Event</code>实现类只需要在需要的时候调用操作的注册方法即可；而在相应方法未注册时进行查找调用的话会忽略或者抛出异常：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">handleMutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="kd">var</span> <span class="nx">handlerMap</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="nx">Event</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">RegisterEventHandler</span><span class="p">(</span><span class="nx">eventType</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlerName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">f</span> <span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="nx">Event</span><span class="p">))</span> <span class="p">{</span>
	<span class="nx">handleMutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">handleMutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">handlerMap</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">handlerMap</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="nx">Event</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">handlerMap</span><span class="p">[</span><span class="nx">eventType</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">handlerMap</span><span class="p">[</span><span class="nx">eventType</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="nx">Event</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="nx">handlerMap</span><span class="p">[</span><span class="nx">eventType</span><span class="p">][</span><span class="nx">handlerName</span><span class="p">]</span> <span class="p">=</span> <span class="nx">f</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">GetEventHandler</span><span class="p">(</span><span class="nx">eventType</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlerName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">f</span> <span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="nx">Event</span><span class="p">),</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">handleMutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">handleMutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">handlerMap</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">handlerMap</span><span class="p">[</span><span class="nx">eventType</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;Unregistered handler for eventType:&#34;</span> <span class="o">+</span> <span class="nx">eventType</span> <span class="o">+</span> <span class="s">&#34; and handlerName:&#34;</span> <span class="o">+</span> <span class="nx">handlerName</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">handlerMap</span><span class="p">[</span><span class="nx">eventType</span><span class="p">][</span><span class="nx">handlerName</span><span class="p">],</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>然后记得注册和使用即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">ProcessClickEvent</span><span class="p">(</span><span class="nx">e</span> <span class="nx">Event</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ce</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.(</span><span class="o">*</span><span class="nx">ClickEvent</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;process ClickEvent with on pos: &#34;</span><span class="p">,</span> <span class="nx">ce</span><span class="p">.</span><span class="nx">OnPosX</span><span class="p">,</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nx">ce</span><span class="p">.</span><span class="nx">OnPosY</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">CancelClickEvent</span><span class="p">(</span><span class="nx">e</span> <span class="nx">Event</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ce</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.(</span><span class="o">*</span><span class="nx">ClickEvent</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;cancel ClickEvent with on pos: &#34;</span><span class="p">,</span> <span class="nx">ce</span><span class="p">.</span><span class="nx">OnPosX</span><span class="p">,</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nx">ce</span><span class="p">.</span><span class="nx">OnPosY</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">ProcessDragEvent</span><span class="p">(</span><span class="nx">e</span> <span class="nx">Event</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">de</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.(</span><span class="o">*</span><span class="nx">DragEvent</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;process DragEvent with to pos: &#34;</span><span class="p">,</span> <span class="nx">de</span><span class="p">.</span><span class="nx">ToPosX</span><span class="p">,</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nx">de</span><span class="p">.</span><span class="nx">ToPosY</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">CancelDragEvent</span><span class="p">(</span><span class="nx">e</span> <span class="nx">Event</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">de</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.(</span><span class="o">*</span><span class="nx">DragEvent</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;cancel DragEvent with to pos: &#34;</span><span class="p">,</span> <span class="nx">de</span><span class="p">.</span><span class="nx">ToPosX</span><span class="p">,</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nx">de</span><span class="p">.</span><span class="nx">ToPosY</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="nf">RegisterExtendEvent</span><span class="p">(</span><span class="s">&#34;click&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">ClickEvent</span><span class="p">{}))</span>
	<span class="nf">RegisterExtendEvent</span><span class="p">(</span><span class="s">&#34;drag&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">DragEvent</span><span class="p">{}))</span>

	<span class="nf">RegisterEventHandler</span><span class="p">(</span><span class="s">&#34;click&#34;</span><span class="p">,</span> <span class="s">&#34;process&#34;</span><span class="p">,</span> <span class="nx">ProcessClickEvent</span><span class="p">)</span>
	<span class="nf">RegisterEventHandler</span><span class="p">(</span><span class="s">&#34;click&#34;</span><span class="p">,</span> <span class="s">&#34;cancel&#34;</span><span class="p">,</span> <span class="nx">CancelClickEvent</span><span class="p">)</span>
	<span class="nf">RegisterEventHandler</span><span class="p">(</span><span class="s">&#34;drag&#34;</span><span class="p">,</span> <span class="s">&#34;process&#34;</span><span class="p">,</span> <span class="nx">ProcessDragEvent</span><span class="p">)</span>
	<span class="nf">RegisterEventHandler</span><span class="p">(</span><span class="s">&#34;drag&#34;</span><span class="p">,</span> <span class="s">&#34;cancel&#34;</span><span class="p">,</span> <span class="nx">CancelDragEvent</span><span class="p">)</span>

	<span class="nx">jsonStr</span> <span class="o">:=</span> <span class="s">`{&#34;event_type&#34;:&#34;click&#34;,&#34;on_pos_x&#34;:10,&#34;on_pos_y&#34;:20}`</span>
	<span class="nx">event</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">unmarshalEvent</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">processFunc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">GetEventHandler</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nf">GetEventType</span><span class="p">(),</span> <span class="s">&#34;process&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">processFunc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">processFunc</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="5-自定义反序列化">5. 自定义反序列化</h2>
<p>前面几节使用了<code>unmarshalEvent</code>进行了事件的反序列化。我们的<code>Event</code>是独立的实体还好说，如果是某个结构体的一部分怎么办？这时候就必须自定义json的反序列化方法了。
比如我们有如下的结构体，然后尝试反序列化:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Panel</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Height</span> <span class="kt">int64</span> <span class="s">`json:&#34;height&#34;`</span>
	<span class="nx">Row</span>    <span class="kt">int64</span> <span class="s">`json:&#34;row&#34;`</span>
	<span class="nx">Event</span>  <span class="nx">Event</span> <span class="s">`json:&#34;event&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">panel</span> <span class="nx">Panel</span>
	<span class="nx">panelJson</span> <span class="o">:=</span> <span class="s">`{&#34;height&#34;: 200, &#34;row&#34;: 100, &#34;event&#34;: {&#34;event_type&#34;:&#34;click&#34;,&#34;on_pos_x&#34;:10,&#34;on_pos_y&#34;:20}}`</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">panelJson</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">panel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">panel</span><span class="p">.</span><span class="nx">Event</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div><p>很可惜，上面的程序报错了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">panic: json: cannot unmarshal object into Go struct field Panel.event of type main.Event
</code></pre></div><p>也就是说，<code>Panel</code>的<code>Event</code>无法反序列化。这是就需要自定义反序列化函数。为了<code>Event</code>的自定义反序列化不影响<code>Panel</code>的其他正常字段，这里可以使用一个小技巧：将<code>Event</code>包装起来：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Panel</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Height</span> <span class="kt">int64</span>        <span class="s">`json:&#34;height&#34;`</span>
	<span class="nx">Row</span>    <span class="kt">int64</span>        <span class="s">`json:&#34;row&#34;`</span>
	<span class="nx">Event</span>  <span class="nx">EventWrapper</span> <span class="s">`json:&#34;event&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">EventWrapper</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Event</span> <span class="nx">Event</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="nx">EventWrapper</span><span class="p">)</span> <span class="nf">MarshalJSON</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">EventWrapper</span><span class="p">)</span> <span class="nf">UnmarshalJSON</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tmpEvent</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">tmpEvent</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">eventType</span> <span class="o">:=</span> <span class="nx">tmpEvent</span><span class="p">[</span><span class="s">&#34;event_type&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">GetEventByType</span><span class="p">(</span><span class="nx">eventType</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">extendEvent</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">).</span><span class="nf">Interface</span><span class="p">()</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">extendEvent</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">w</span><span class="p">.</span><span class="nx">Event</span> <span class="p">=</span> <span class="nx">extendEvent</span><span class="p">.(</span><span class="nx">Event</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nf">RegisterExtendEvent</span><span class="p">(</span><span class="s">&#34;click&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">ClickEvent</span><span class="p">{}))</span>
	<span class="nf">RegisterExtendEvent</span><span class="p">(</span><span class="s">&#34;drag&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">DragEvent</span><span class="p">{}))</span>

	<span class="kd">var</span> <span class="nx">panel</span> <span class="nx">Panel</span>
	<span class="nx">panelJson</span> <span class="o">:=</span> <span class="s">`{&#34;height&#34;: 200, &#34;row&#34;: 100, &#34;event&#34;: {&#34;event_type&#34;:&#34;click&#34;,&#34;on_pos_x&#34;:10,&#34;on_pos_y&#34;:20}}`</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">panelJson</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">panel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">panel</span><span class="p">.</span><span class="nx">Event</span><span class="p">))</span>

	<span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">panel</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div><p>回过头来，如果我们从一开始不是使用接口而是直接使用结构体来定义<code>Event</code>，事情又会变得不一样。我们只需要处理一件事情，那就是结构体之间的相互转换。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Event</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">EventType</span>  <span class="kt">string</span>      <span class="s">`json:&#34;event_type&#34;`</span>
	<span class="nx">EventParam</span> <span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;event_param&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Event</span><span class="p">)</span> <span class="nf">UnmarshalJSON</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

	<span class="c1">// 使用新类型，避免递归调用
</span><span class="c1"></span>	<span class="kd">type</span> <span class="nx">cloneType</span> <span class="nx">Event</span>

	<span class="nx">rawMsg</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">{}</span>
	<span class="nx">e</span><span class="p">.</span><span class="nx">EventParam</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">rawMsg</span> <span class="c1">//将Param强制赋值为json.RawMessage，避免使用默认的map[string]interface{}
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">cloneType</span><span class="p">)(</span><span class="nx">e</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">GetEventByType</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">EventType</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">extendEvent</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">).</span><span class="nf">Interface</span><span class="p">()</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rawMsg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">rawMsg</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">extendEvent</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">//使用rawMsg进行序列化，rawMsg由前面的反序列化得来
</span><span class="c1"></span>			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">e</span><span class="p">.</span><span class="nx">EventParam</span> <span class="p">=</span> <span class="nx">extendEvent</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nf">RegisterExtendEvent</span><span class="p">(</span><span class="s">&#34;click&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">ClickEvent</span><span class="p">{}))</span>
	<span class="nf">RegisterExtendEvent</span><span class="p">(</span><span class="s">&#34;drag&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">DragEvent</span><span class="p">{}))</span>

	<span class="nx">jsonStr</span> <span class="o">:=</span> <span class="s">`{&#34;event_type&#34;:&#34;click&#34;, &#34;event_param&#34;: {&#34;on_pos_x&#34;:10,&#34;on_pos_y&#34;:20}}`</span>
	<span class="kd">var</span> <span class="nx">event</span> <span class="nx">Event</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">event</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">EventParam</span><span class="p">.(</span><span class="o">*</span><span class="nx">ClickEvent</span><span class="p">).</span><span class="nx">OnPosX</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>这个时候无需包装结构体，在反序列化的时候使用<code>RawMessage</code>进行延迟处理即可。</p>
<h2 id="6-总结">6. 总结</h2>
<p>由于go语言没有完整的面向对象的类型支持和泛型支持，所以在处理时需要自己考虑持久化的数据结构如何以及如何反序列化回来，还有就是怎么进行灵活的类型和方法绑定。最后的实现方式似乎越来越接近面向对象支持的底层实现，说不定有一天看到c++的面向对象实现原理，会有一种“啊，这一块的实现方式我之前也有写过”的奇妙感觉。</p>
</div>
    <div class="post-footer">
      <div class="info">
        
          <span class="separator"><a class="category" href="/categories/coding/">coding</a></span>




        

        
          <span class="separator"><a class="tag" href="/tags/go/">go</a></span>




        
      </div>
    </div>

    
  </div>


          </div>
        </div>
      </main>
    </div><footer class="footer footer--base">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2019-2021

        
      </li>
      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js"
    integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I="
    crossorigin="anonymous"
  ></script></body>
</html>
